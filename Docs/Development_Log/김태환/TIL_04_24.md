# TIL 04.24

ë‚ ì§œ: 2024ë…„ 4ì›” 24ì¼

### ì¼ì •

---

- ESP32ë¡œ ìš°íšŒ

- Port : COM5
- Board : ESP 32 Dev Module
    
    

### UWB(Ultra-WideBand) í†µì‹ 

---

- 3.1 ~ 10.6GHz ì‚¬ì´ì˜ ì£¼íŒŒìˆ˜ ë²”ìœ„ì—ì„œ ì±„ë„ë‹¹ 500MHzì˜ ëŒ€ì—­í­ì„ ì‚¬ìš©í•˜ì—¬ í†µì‹ í•˜ëŠ” ë¬´ì„  í†µì‹  ê¸°ìˆ 
    - êµ­ë‚´ì—ì„œëŠ” ê¸°ì¡´ ë¬´ì„ ê¸°ê¸°ì™€ì˜ ê°„ì„­ ê²½ê°ì„ ìœ„í•´ 7.2 ~ 10.2GHz (8 ~ 14ch)ë§Œ ì‚¬ìš© ê°€ëŠ¥
- 1ns ì´í•˜ì˜ ì§§ì€ í­ì˜ Pulseë¥¼ ë„“ì€ ëŒ€ì—­ì— ê±¸ì³ ì†¡ìˆ˜ì‹ 
- ë„“ì€ ëŒ€ì—­ì—ì„œ ë‚®ì€ ì§„í­ìœ¼ë¡œ ì „ë‹¬í•˜ê¸° ë•Œë¬¸ì— ì†Œë¹„ ì „ë ¥ì´ ì ê³ , ê³ ì† í†µì‹ ì´ ê°€ëŠ¥
- ìœ„ì¹˜ ì¶”ì • ì˜¤ì°¨ 10cm ì´ë‚´
    
    ![Untitled](./images/uwb_.png)
    
    ![Untitled](./images/distance_cal.png)
    
    
- í”„ë¡œì íŠ¸ì—ì„œëŠ” ì•ˆë‚´ ì†ì¡ì´(Anchor)ì™€ ì•ˆë‚´ ë¡œë´‡(Tag) ì‚¬ì´ì˜ ê±°ë¦¬ ì¸¡ì •ì— í•´ë‹¹ ê¸°ìˆ ì„ ì‚¬ìš©í•  ì˜ˆì •
- ì°¸ì¡° ë¬¸í—Œ
    
    [J. Korean Inst. Electromagn. Eng.: Principles and Trends of UWB Positioning Technology](https://www.jkiees.org/archive/view_article?pid=jkiees-33-1-1)
    

### UWB ëª¨ë“ˆ (DWM1000)

---

- Qorvoì‚¬ì—ì„œ ìœ í†µí•˜ëŠ” UWB ì†¡ìˆ˜ì‹  ëª¨ë“ˆ
- SPI ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ í†µì‹  ë°ì´í„° ì œê³µ
    
    [Ultra-Wideband - Qorvo](https://www.qorvo.com/products/wireless-connectivity/ultra-wideband#ta0116)
    

- DW1000 user manual ê¸°ë°˜ìœ¼ë¡œ ì†ŒìŠ¤ ì½”ë“œ ê°œë°œ

### ì°¸ê³  ìë£Œ

---

[https://github.com/thotro/arduino-dw1000](https://github.com/thotro/arduino-dw1000)

- arduino ê¸°ë°˜ dw1000 ì‚¬ìš©ì„ ìœ„í•œ ì˜¤í”ˆ ì†ŒìŠ¤

[https://github.com/F-Army/arduino-dw1000-ng](https://github.com/F-Army/arduino-dw1000-ng)

- ESP32(ì•ˆë‚´ ì†ì¡ì´)ì—ì„œ ì‚¬ìš©í•  ì†ŒìŠ¤
    
    [DWM1000( UWBí†µì‹ ëª¨ë“ˆ) í…ŒìŠ¤íŠ¸](https://makernambo.com/162)
    
    - ìœ„ ì‚¬ì´íŠ¸ë¥¼ ë”°ë¼ ESP32ì— arduino IDEë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬í˜„

### UWB í†µì‹  ì†ŒìŠ¤ ì½”ë“œ ì •ë¦¬

---

- ìœ„ ì°¸ê³  ìë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ UWBë¥¼ í†µí•œ ê±°ë¦¬ ì¸¡ì • ê´€ë ¨ ê¸°ëŠ¥ ì •ë¦¬

- ì½”ë“œ êµ¬ì„±
    - Anchor
    - Tag
    - module

- ë™ì‘ ì›ë¦¬
    1. Anchorë¡œ ì‚¬ìš©ë˜ëŠ” ëª¨ë“ˆê³¼ Tagë¡œ ì‚¬ìš©ë˜ëŠ” ëª¨ë“ˆë¡œ ë‚˜ë‰¨
    2. Anchor ëª¨ë“ˆì—ì„œ ì‹ í˜¸ë¥¼ ë°›ì„ ì¤€ë¹„
        - Anchorëª¨ë“ˆ loopë¬¸ì´ ë™ì‘í•˜ëŠ” ê³¼ì •
            1. ìµœì´ˆ sentAckì™€ receivedAckì˜ ê°’ì´ falseì¼ ë•Œ, resetInactive()ê°€ ë™ì‘
                
                ```arduino
                    if (!sentAck && !receivedAck) {
                        // check if inactive
                        if (curMillis - lastActivity > resetPeriod) {
                            resetInactive();
                        }
                        return;
                    }
                ```
                
            2. resetInactiveì—ì„œ ì•„ë˜ í•¨ìˆ˜ ë™ì‘
                1. receiver()
                    
                    ```arduino
                    void receiver() {
                        DW1000Ng::forceTRxOff();
                        // so we don't need to restart the receiver manually
                        DW1000Ng::startReceive();
                    }
                    ```
                    
                    - forceTRxOff()
                        
                        ```cpp
                        	void forceTRxOff() {
                        		memset(_sysctrl, 0, LEN_SYS_CTRL);
                        		DW1000NgUtils::setBit(_sysctrl, LEN_SYS_CTRL, TRXOFF_BIT, true);
                        		_writeBytesToRegister(SYS_CTRL, NO_SUB, _sysctrl, LEN_SYS_CTRL);
                        	}
                        ```
                        
                        - SYS_CTRL ë ˆì§€ìŠ¤í„°ì˜ TRXOFF_BIT ë¶€ë¶„(0x06) trueê°’ ì…ë ¥
                    - startReceive()
                        
                        ```cpp
                        	void startReceive(ReceiveMode mode) {
                        		memset(_sysctrl, 0, LEN_SYS_CTRL);
                        		DW1000NgUtils::setBit(_sysctrl, LEN_SYS_CTRL, SFCST_BIT, !_frameCheck);
                        		if(mode == ReceiveMode::DELAYED)
                        			DW1000NgUtils::setBit(_sysctrl, LEN_SYS_CTRL, RXDLYS_BIT, true);
                        		DW1000NgUtils::setBit(_sysctrl, LEN_SYS_CTRL, RXENAB_BIT, true);
                        		_writeBytesToRegister(SYS_CTRL, NO_SUB, _sysctrl, LEN_SYS_CTRL);
                        	}
                        ```
                        
                        - SYS_CTRL ë ˆì§€ìŠ¤í„°ì˜ SFCST_BITì— frameCheckê°’ ì…ë ¥ (ì½”ë“œ ìœ íš¨ì„± ê²€ì‚¬ FCSë¥¼ ìœ„í•œ ì‘ì—…)
                        - ì´í›„ RXENAB_BITì— trueê°’ ì…ë ¥
                        - RXENAB_BITê°€ trueë¡œ ë³€ê²½ë˜ë©´ ìˆ˜ì‹ ê¸°ê°€ í™œì„±í™”ë˜ë©´ì„œ preamble sequenceê°€ ìˆ˜ì‹  ë˜ê¸°ë¥¼ ë°˜ë³µí•˜ì—¬ íƒìƒ‰
                        - ìˆ˜ì‹ ê¸°ê°€ í™œì„±í™”ë˜ë©´ interruptServiceRoutine()ì´ ë™ì‘ (ì™œ ë™ì‘í•˜ëŠ”ì§€ ëª¨ë¥´ê² ìŒ)
                        - ìˆ˜ì‹ ê¸° í™œì„±ì´ ë˜ë©´ì„œ SYS_STATUSì˜ RXDFR_BITê°€ í™œì„±í™” ë˜ì—ˆê³ , ì´ì— ë”°ë¼ _isReceiveDone()ì˜ ê°’ì´ trueë¡œ rerturn
                        - ReceiveStatusê°€ ì´ˆê¸°í™” ë˜ë©´ì„œ _handleReceived ë™ì‘
                            - _handleReceived
                                
                                ```cpp
                                	void attachReceivedHandler(void (* handleReceived)(void)) {
                                		_handleReceived = handleReceived;
                                	}
                                ```
                                
                                ```cpp
                                    DW1000Ng::attachReceivedHandler(handleReceived);
                                    
                                    void handleReceived() {
                                    // status change on received success
                                    receivedAck = true;
                                }
                                ```
                                
                                - ìœ„ ë³€ìˆ˜ëŠ” ì½œë°± í•¨ìˆ˜ì¸ handleReceived()ë¥¼ ì €ì¥í•˜ê³  ìˆëŠ” ë©¤ë²„ ë³€ìˆ˜ì˜€ìœ¼ë¯€ë¡œ ë™ì‘ ì‹œ Anchor ëª¨ë“ˆì˜ receivedAckê°€ trueë¡œ ë³€ê²½ë¨
                    
                    <aside>
                    ğŸ’¡ receiver() ë™ì‘ ìš”ì•½
                    
                    1. DWM1000ì´ ìˆ˜ì‹  ëŒ€ê¸° ìƒíƒœë¡œ ì „í™˜
                    2. handleReceived()ê°€ ë™ì‘í•˜ì—¬ ReceivedAck ê°’ì´ trueë¡œ ë°”ë€œ
                    </aside>
                    
                2. noteActivity
                    - lastActivity ê°’ ë™ê¸°í™”
                    
            3. if(receivedAck)  ë‚´ë¶€ ë™ì‘ 
                1. receivedAck â†’ falseë¡œ ë³€ê²½ (data ëª» ë°›ì„ ê²½ìš° 2ë²ˆ ë°˜ë³µì„ ìœ„í•´)
                2. getReceivedData(data, LEN_DATA) ë™ì‘
                    
                    ```cpp
                    	void getReceivedData(byte data[], uint16_t n) {
                    		if(n <= 0) {
                    			return;
                    		}
                    		_readBytesFromRegister(RX_BUFFER, NO_SUB, data, n);
                    	}
                    
                    	void getReceivedData(String& data) {
                    		uint16_t i;
                    		uint16_t n = getReceivedDataLength(); // number of bytes w/o the two FCS ones
                    		if(n <= 0) { // TODO
                    			return;
                    		}
                    		byte* dataBytes = (byte*)malloc(n);
                    		getReceivedData(dataBytes, n);
                    		// clear string
                    		data.remove(0);
                    		data  = "";
                    		// append to string
                    		for(i = 0; i < n; i++) {
                    			data += (char)dataBytes[i];
                    		}
                    		free(dataBytes);
                    	}
                    ```
                    
                    - RX_BUFFERì— ì €ì¥ëœ dataë¥¼ ì½ì–´ì„œ dataì— ì €ì¥
                3. ë°›ì€ dataì˜ 0ë²ˆì§€ ê°’ì„ msgIdì— ì €ì¥
                    - msgIdê°€ expectedMsgIdì™€ ë‹¤ë¥¼ ê²½ìš° â†’ protocolFailed â†’ ì•„ë¬´ ë™ì‘ ì•ˆí•¨
                    - msgId == POLL â†’ ì´ˆê¸°í™”, ë˜ëŠ” ì‹œì‘í–ˆì„ ë•Œ ê°’
                        - ë³´ë‚¸ ì‹œê°„ (ReceivedTimeStamp)ì„ ì €ì¥í•˜ê³ 
                        - expectedMsgIdë¥¼ Range (ëŒì•„ì˜¨ ê°’ìœ¼ë¡œ ìœ„ì¹˜ ê³„ì‚°í•˜ëŠ” ëª¨ë“œ)ë¡œ ë³€ê²½
                        - ì‹ í˜¸ ì „ì†¡ (transmitPollAck)
                            
                            ```cpp
                            void transmitPollAck() {
                                data[0] = POLL_ACK;
                                DW1000Ng::setTransmitData(data, LEN_DATA);
                                DW1000Ng::startTransmit();
                            }
                            ```
                            
                            - setTransmitData
                                
                                ```cpp
                                void setTransmitData(byte data[], uint16_t n) {
                                		if(_frameCheck) {
                                			n += 2; // two bytes CRC-16
                                		}
                                		if(n > LEN_EXT_UWB_FRAMES) {
                                			return; // TODO proper error handling: frame/buffer size
                                		}
                                		if(n > LEN_UWB_FRAMES && !_extendedFrameLength) {
                                			return; // TODO proper error handling: frame/buffer size
                                		}
                                		// transmit data and length
                                		_writeBytesToRegister(TX_BUFFER, NO_SUB, data, n);
                                		
                                		/* Sets up transmit frame control length based on data length */
                                		_txfctrl[0] = (byte)(n & 0xFF); // 1 byte (regular length + 1 bit)
                                		_txfctrl[1] &= 0xE0;
                                		_txfctrl[1] |= (byte)((n >> 8) & 0x03);  // 2 added bits if extended length
                                		_writeTransmitFrameControlRegister();
                                	}
                                ```
                                
                                - data[0]ì— POLL_ACKë¥¼ ë‹´ì•„ ì „ì†¡í•˜ë©´, Tag loopì—ì„œ Anchorê°€ ì „ì†¡í•œ ì‹ í˜¸ë¥¼ ë°›ì•˜ë‹¤ê³  ì¸ì‹í•˜ì—¬ ê±°ë¦¬ê°ì§€ë¥¼ ì‹œì‘í•¨
                                - _txfctrlì— ì „ì†¡í•  ë°ì´í„°ë¥¼ ì¶”ê°€
                                    
                                    ```cpp
                                    void _writeTransmitFrameControlRegister() {
                                    			_writeBytesToRegister(TX_FCTRL, NO_SUB, _txfctrl, LEN_TX_FCTRL);
                                    		}
                                    ```
                                    
                                - TX_FCTRL ë ˆì§€ìŠ¤í„°ì— _txfctrl ì €ì¥
                                
                            - startTransmit
                                
                                ```cpp
                                	void startTransmit(TransmitMode mode) {
                                		memset(_sysctrl, 0, LEN_SYS_CTRL);
                                		DW1000NgUtils::setBit(_sysctrl, LEN_SYS_CTRL, SFCST_BIT, !_frameCheck);
                                		if(mode == TransmitMode::DELAYED)
                                			DW1000NgUtils::setBit(_sysctrl, LEN_SYS_CTRL, TXDLYS_BIT, true);
                                		if(_wait4resp)
                                			DW1000NgUtils::setBit(_sysctrl, LEN_SYS_CTRL, WAIT4RESP_BIT, true);
                                
                                		DW1000NgUtils::setBit(_sysctrl, LEN_SYS_CTRL, TXSTRT_BIT, true);
                                		_writeBytesToRegister(SYS_CTRL, NO_SUB, _sysctrl, LEN_SYS_CTRL);
                                	}
                                ```
                                
                                - SYS_CTRL ë ˆì§€ìŠ¤í„°ì˜ TX_STRT_BIT í™œì„±í™”
                                    - ìœ„ ë ˆì§€ìŠ¤í„° í™œì„±í™” ì¦‰ì‹œ ICì—ì„œ í”„ë ˆì„ ì „ì†¡ì„ ì‹œì‘í•¨
                                    - ë‹¨, TX_DLYS_BITê°€ ì„¤ì •ë˜ì–´ ìˆì„ ê²½ìš° ì •í•´ì§„ ë§Œí¼ ì§€ì—° í›„ ì‹œì‘
                                - receivedì™€ ë§ˆì°¬ê°€ì§€ë¡œ ì „ì†¡ ì„±ê³µ ì‹œ _handleSent ì½œë°± (handleSent) ë™ì‘ì— ì˜í•´ sentAck â†’ trueë¡œ ë³€í™˜
                                    - ì „ì†¡ ì„±ê³µí•˜ë©´ timePollAckSent ê°’ì— í˜„ì¬ TimeStampë¥¼ ì €ì¥
                                
                    
    3. Anchor ëª¨ë“ˆì—ì„œ ì¤€ë¹„ ì‹ í˜¸ë¥¼ ì „ì†¡í•˜ë©´ Tagì—ì„œ POLL ì‹ í˜¸ë¥¼ ì „ì†¡
        - Tag ëª¨ë“ˆ loopë¬¸ì´ ë™ì‘í•˜ëŠ” ê³¼ì •
            - Tag ëª¨ë“ˆì€ ê¸°ë³¸ì ìœ¼ë¡œ Anchor ëª¨ë“ˆë¡œ ê³„ì†í•˜ì—¬ ì‹ í˜¸ë¥¼ ì „ì†¡í•¨
            - Anchor ëª¨ë“ˆì˜ ì¤€ë¹„ ì‹ í˜¸ë¥¼ ìˆ˜ì‹ í•˜ê²Œ ë˜ë©´ POLL ì‹ í˜¸ë¥¼ Anchorëª¨ë“ˆë¡œ ì „ì†¡
            - Anchor ëª¨ë“ˆì˜ POLL_ACK ì‹ í˜¸ë¥¼ ìˆ˜ì‹ í•˜ê²Œ ë˜ë©´ í•„ìš”í•œ ì‹œê°„ê°’ì„ ë‹´ì•„ RANGE ì‹ í˜¸ë¥¼ ì „ì†¡
            - Anchor ëª¨ë“ˆì˜ RANGE_REPORT ì‹ í˜¸ë¥¼ ìˆ˜ì‹ í•˜ê²Œ ë˜ë©´ í˜„ì¬ ìœ„ì¹˜ë¥¼ ì €ì¥í•˜ê³  ë‹¤ì‹œ POLL ì‹ í˜¸ë¥¼ ì „ì†¡
            
            1. ìµœì´ˆ sentAckì™€ receivedAckì˜ ê°’ì´ falseì¼ ë•Œ, resetInactive()ê°€ ë™ì‘ Anchorëª¨ë“ˆê³¼ ë‹¤ë¦„
                
                ```cpp
                // 
                void resetInactive() {
                  // tag sends POLL and listens for POLL_ACK
                  expectedMsgId = POLL_ACK;
                  DW1000Ng::forceTRxOff();
                  transmitPoll();
                  noteActivity();
                }
                ```
                
                - TRXOFF_BIT on â†’ ì „ì†¡ data TX_BUFFERì— ì €ì¥ â†’ ì‹ í˜¸ ì „ì†¡ â†’ sentAck True
            2. if(sentAck)
                
                ```cpp
                  if (sentAck) {
                    sentAck = false;
                    DW1000Ng::startReceive();
                  }
                ```
                
                - RXENAB_BIT on â†’ receivedAck True
            3. if(receivedAck)
                - msgIdê°€ POLL_ACKì¼ ë•Œ, ì‹ í˜¸ë¥¼ ì „ì†¡í•œ ì‹œê°„ê³¼ ë°›ì€ ì‹œê°„ì„ ì €ì¥í•˜ì—¬ transmitRange() ë™ì‘ + í˜„ì¬ MsgIdë¥¼ Range_reportë¡œ ì „í™˜
                - Anchorì—ì„œ ë³´ë‚¸ ì‹ í˜¸ë¥¼ ë°›ì•˜ì„ ê²½ìš° data[0] ì´ POLL_ACK ê°’ìœ¼ë¡œ ë“¤ì–´ì˜´
                    
                    ```cpp
                    void transmitRange() {
                      data[0] = RANGE;
                    
                      /* Calculation of future time */
                      byte futureTimeBytes[LENGTH_TIMESTAMP];
                    
                      timeRangeSent = DW1000Ng::getSystemTimestamp();
                      timeRangeSent += DW1000NgTime::microsecondsToUWBTime(replyDelayTimeUS);
                      DW1000NgUtils::writeValueToBytes(futureTimeBytes, timeRangeSent, LENGTH_TIMESTAMP);
                      DW1000Ng::setDelayedTRX(futureTimeBytes);
                      timeRangeSent += DW1000Ng::getTxAntennaDelay();
                    
                      DW1000NgUtils::writeValueToBytes(data + 1, timePollSent, LENGTH_TIMESTAMP);
                      DW1000NgUtils::writeValueToBytes(data + 6, timePollAckReceived, LENGTH_TIMESTAMP);
                      DW1000NgUtils::writeValueToBytes(data + 11, timeRangeSent, LENGTH_TIMESTAMP);
                      DW1000Ng::setTransmitData(data, LEN_DATA);
                      DW1000Ng::startTransmit(TransmitMode::DELAYED);
                      //Serial.print("Expect RANGE to be sent @ "); Serial.println(timeRangeSent.getAsFloat());
                    }
                    ```
                    
                    - getSystemTimestamp : SYS_TIME ë ˆì§€ìŠ¤í„°ì˜ ê°’ ì½ìŒ
                        - SYS_TIME ë ˆì§€ìŠ¤í„° ì €ì¥ ì‹œê°„
                            - Manual ì„¤ëª…
                                
                                Register map register file 0x06 is the System Time Counter register. System time and time stamps are designed to be based on the time units which are nominally at 64 GHz, or more precisely 499.2 MHz Ã— 128 which is 63.8976 GHz. In line with this when the DW1000 is in idle mode with the digital PLL enabled, the System Time Counter is incremented at a rate of 125 MHz in units of 512. The nine low-order bits of this register are thus always zero. The counter wrap period of the clock is then: 2^40 Ã· (128Ã—499.2e6) = 17.2074
                                seconds.
                                Notes
                                
                                (a) On power up, before the digital PLL is enabled, the System Time Counter increments are still in units of 512 however the increment rate is half the external crystal frequency, (e.g. at 19.2 MHz for the 38.4 MHz crystal). The counter wrap period is then: 231 Ã· 19.2e6 = 111.8481 seconds.
                                (b) In sleep modes the system time counter is disabled and this register is not updated.
                                
                            - 
                    - microsecondsToUWBTime : ë¯¸ë¦¬ ì„ ì–¸í•œ delaytimeì„ ì—°ì‚°í•˜ì—¬ timeRangeSentì— ì¶”ê°€
                        
                        ```cpp
                        uint16_t replyDelayTimeUS = 3000;
                        
                        // DW1000NgTime.cpp
                        namespace DW1000NgTime {
                            uint64_t microsecondsToUWBTime(uint64_t microSeconds) {
                                return static_cast<uint64_t>(microSeconds * TIME_RES_INV);
                            }
                        }
                        ```
                        
                    - writeValueToBytes : futureTimeBytesì— timeRangeSentê°’ ë°”ì´íŠ¸ ë‹¨ìœ„ ì €ì¥ â†’ setDelayedTRX : delayì‹œê°„ DX_TIME ë ˆì§€ìŠ¤í„°ì— ì €ì¥
                    - getTxAntennaDelay : _antennaTxDelayê°’ì„ timeRangeSentì— ì¶”ê°€
                    - writeValueToBytes(data, ~)
                        - data[0] : RANGE
                        - data + 1 : timePollSent - ì „ì†¡ ì‹œì  ì‹œê°„
                        - data + 6 : timePollAckReceived - ìˆ˜ì‹  ì‹œì  ì‹œê°„
                        - data + 11 : timeRangeSent - SYS_TIME + ì „ì†¡ ì§€ì—° ì‹œê°„
                    - data ê°’ ì €ì¥ í•œ ë‹¤ìŒ TX_BUFFERì— ì €ì¥ í›„ â†’ SYS_CTRL ë ˆì§€ìŠ¤í„°ì— TXSTRT_BIT í™œì„±í™” â†’ ë°ì´í„° ì „ì†¡
                    
                    <aside>
                    ğŸ’¡ transmitRange ìš”ì•½
                    
                    1. Anchorë¡œ ë¶€í„° ì „ì†¡ ë°›ì€ ì‹œì ì— í˜„ì¬ SYS_TIMEê³¼ ì „ì†¡ì‹œê°„, ìˆ˜ì‹  ì‹œê°„ì„ dataì— ë‹´ê³ 
                    2. TX_BUFFERì— ì…ë ¥ ì‹œí‚¨ ë‹¤ìŒ
                    3. ë²„í¼ì— ì €ì¥ëœ dataë¥¼ ì „ì†¡í•¨
                    </aside>
                    
    4. data[0]ê°€ Rangeì¸ ì‹ í˜¸ë¥¼ Anchorê°€ ìˆ˜ì‹  ë°›ìœ¼ë©´ ë‘ ëª¨ë“ˆê°„ ê±°ë¦¬ë¥¼ ì—°ì‚°í•˜ì—¬ ì¶œë ¥
        - ì‹ í˜¸ ìˆ˜ì‹  ë° ì—°ì‚° ê³¼ì •
            - distance ì—°ì‚°ì„ ìœ„í•´ 6ê°€ì§€ì˜ ë³€ìˆ˜ë¥¼ ë‹´ì•„ computeRangeAsymmetric ìˆ˜í–‰
                
                ```cpp
                timeRangeReceived = DW1000Ng::getReceiveTimestamp();
                
                timePollSent = DW1000NgUtils::bytesAsValue(data + 1, LENGTH_TIMESTAMP);
                timePollAckReceived = DW1000NgUtils::bytesAsValue(data + 6, LENGTH_TIMESTAMP);
                timeRangeSent = DW1000NgUtils::bytesAsValue(data + 11, LENGTH_TIMESTAMP);
                // (re-)compute range as two-way ranging is done
                double distance = DW1000NgRanging::computeRangeAsymmetric(timePollSent,
                                                            timePollReceived, 
                                                            timePollAckSent, 
                                                            timePollAckReceived, 
                                                            timeRangeSent, 
                                                            timeRangeReceived);
                /* Apply simple bias correction */
                distance = DW1000NgRanging::correctRange(distance);
                ```
                
                - timePollSent, timePollAckReceived, timeRangeSent : Tag ëª¨ë“ˆì—ì„œ ì¸¡ì •í•œ ì‹œê°„ê°’ë“¤
                - timePollReceived : Tagì—ì„œ ì „ì†¡í•œ ì‹ í˜¸ë¥¼ Anchorì—ì„œ ë°›ì€ ì‹œì 
                - timePollAckSent : Anchor ëª¨ë“ˆì—ì„œ Tagë¡œ POLL_ACKì‹ í˜¸ë¥¼ ì „ì†¡í•œ ì‹œì 
                - timeRangeReceived : POLL_ACK ì‹ í˜¸ë¥¼ ë°›ì€ Tagì—ì„œ ë‹¤ì‹œ RANGE ì‹ í˜¸ë¥¼ ì „ì†¡í•˜ê³  Anchor ëª¨ë“ˆì—ì„œ RANGE ì‹ í˜¸ë¥¼ ë°›ì€ ì‹œì 
            - distance ì—°ì‚°
                
                ```cpp
                double computeRangeAsymmetric(   
                                                uint64_t timePollSent,
                                                uint64_t timePollReceived,
                                                uint64_t timePollAckSent,
                                                uint64_t timePollAckReceived,
                                                uint64_t timeRangeSent,
                                                uint64_t timeRangeReceived
                                            )
                {
                    uint32_t timePollSent_32 = static_cast<uint32_t>(timePollSent);
                    uint32_t timePollReceived_32 = static_cast<uint32_t>(timePollReceived);
                    uint32_t timePollAckSent_32 = static_cast<uint32_t>(timePollAckSent);
                    uint32_t timePollAckReceived_32 = static_cast<uint32_t>(timePollAckReceived);
                    uint32_t timeRangeSent_32 = static_cast<uint32_t>(timeRangeSent);
                    uint32_t timeRangeReceived_32 = static_cast<uint32_t>(timeRangeReceived);
                   
                    double round1 = static_cast<double>(timePollAckReceived_32 - timePollSent_32);
                    double reply1 = static_cast<double>(timePollAckSent_32 - timePollReceived_32);
                    double round2 = static_cast<double>(timeRangeReceived_32 - timePollAckSent_32);
                    double reply2 = static_cast<double>(timeRangeSent_32 - timePollAckReceived_32);
                
                    int64_t tof_uwb = static_cast<int64_t>((round1 * round2 - reply1 * reply2) / (round1 + round2 + reply1 + reply2));
                    double distance = tof_uwb * DISTANCE_OF_RADIO;
                
                    return distance;
                }
                ```
                
                ![Untitled](./images/distance_cal.png)
                
                - ìœ„ ì‹ê³¼ ê°™ì´ ì—°ì‚°í•˜ì—¬ Anchorì™€ Tag ëª¨ë“ˆ ì‚¬ì´ ê±°ë¦¬ ê°’ì„ ë°˜í™˜
                - ì£¼íŒŒìˆ˜ì— ë”°ë¥¸ í¸í–¥ ì˜¤ì°¨ ë³´ì • (ë­”ì§€ ëª¨ë¥´ê² ìŒ)
                    
                    ```cpp
                    distance = DW1000NgRanging::correctRange(distance);
                    ```
                    
                - RANGE_REPORT ì •ë³´ë¥¼ ë‹´ì€ ì‹ í˜¸ë¥¼ Tag ëª¨ë“ˆë¡œ ì „ì†¡, ì¸ìì— í˜„ì¬ ìœ„ì¹˜ë¥¼ ë‹´ì•„ ë³´ëƒ„
                    
                    ```cpp
                    	/* Speed of radio waves (light) [m/s] * timestamp resolution [~15.65ps] of DW1000Ng */
                    	constexpr float DISTANCE_OF_RADIO     = 0.0046917639786159f;
                    	constexpr float DISTANCE_OF_RADIO_INV = 213.139451293f;
                    
                    void transmitRangeReport(float curRange) {
                        data[0] = RANGE_REPORT;
                        // write final ranging result
                        memcpy(data + 1, &curRange, 4);
                        DW1000Ng::setTransmitData(data, LEN_DATA);
                        DW1000Ng::startTransmit();
                    }
                    
                    transmitRangeReport(distance * DISTANCE_OF_RADIO_INV);
                    ```
                    
                - Tag ëª¨ë“ˆì—ì„œ RANGE_REPORTë¥¼ ë°›ìœ¼ë©´ í˜„ì¬ ìœ„ì¹˜ ê°’ì„ ì €ì¥í•œ ë‹¤ìŒ POLL ì •ë³´ë¥¼ ë‹´ì€ ì‹ í˜¸ë¥¼ ë‹¤ì‹œ Anchorë¡œ ì „ì†¡í•¨ (ìœ„ì¹˜ í™•ì¸ 1íšŒì°¨ ì¢…ë£Œ)

---

- ì†ŒìŠ¤ ì½”ë“œ ì •ë¦¬
    
    ```cpp
    void loop() {
      if (!sentAck && !receivedAck) {
        // check if inactive
        if (millis() - lastActivity > resetPeriod) {
          resetInactive();
        }
        return;
      }
      // continue on any success confirmation
      if (sentAck) {
        sentAck = false;
        DW1000Ng::startReceive();
      }
      if (receivedAck) {
        receivedAck = false;
        // get message and parse
        DW1000Ng::getReceivedData(data, LEN_DATA);
        byte msgId = data[0];
        if (msgId != expectedMsgId) {
          // unexpected message, start over again
          //Serial.print("Received wrong message # "); Serial.println(msgId);
          expectedMsgId = POLL_ACK;
          transmitPoll();
          return;
        }
        if (msgId == POLL_ACK) {
          timePollSent = DW1000Ng::getTransmitTimestamp();
          timePollAckReceived = DW1000Ng::getReceiveTimestamp();
          expectedMsgId = RANGE_REPORT;
          transmitRange();
          noteActivity();
        } else if (msgId == RANGE_REPORT) {
          expectedMsgId = POLL_ACK;
          float curRange;
          memcpy(&curRange, data + 1, 4);
          delay(100);
          transmitPoll();
          noteActivity();
        } else if (msgId == RANGE_FAILED) {
          expectedMsgId = POLL_ACK;
          transmitPoll();
          noteActivity();
        }
      }
    }
    ```
    
    - sentAck
        
        ```cpp
        volatile boolean sentAck = false;
        
        void handleSent() {
          // status change on sent success
          sentAck = true;
        }
        
        // ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜
        
        if (sentAck) {
            sentAck = false;
            DW1000Ng::startReceive();
          }
        ```
        
        - handleSent ë™ì‘ ì‹œ sentAck â†’ trueë¡œ ë³€ê²½
        - sentAck trueë©´ startReceive ìˆ˜í–‰
            
            ```cpp
            //hpp
            void startReceive(ReceiveMode mode = ReceiveMode::IMMEDIATE);
            
            //cpp
            constexpr uint16_t LEN_SYS_CTRL = 4;
            constexpr uint16_t SFCST_BIT = 0;
            constexpr uint16_t RXENAB_BIT = 8;
            constexpr uint16_t RXDLYS_BIT = 9;
            constexpr uint16_t NO_SUB = 0xFF;
            
            byte       _sysctrl[LEN_SYS_CTRL];
            
            void startReceive(ReceiveMode mode) {
            		memset(_sysctrl, 0, LEN_SYS_CTRL);
            		DW1000NgUtils::setBit(_sysctrl, LEN_SYS_CTRL, SFCST_BIT, !_frameCheck);
            		if(mode == ReceiveMode::DELAYED)
            			DW1000NgUtils::setBit(_sysctrl, LEN_SYS_CTRL, RXDLYS_BIT, true);
            		DW1000NgUtils::setBit(_sysctrl, LEN_SYS_CTRL, RXENAB_BIT, true);
            		_writeBytesToRegister(SYS_CTRL, NO_SUB, _sysctrl, LEN_SYS_CTRL);
            	}
            	
            ```
            
            - setbit
                
                ```cpp
                void setBit(byte data[], uint16_t n, uint16_t bit, boolean val) {
                		uint16_t idx;
                		uint8_t shift;
                		
                		idx = bit/8;
                		if(idx >= n) {
                			return; // TODO proper error handling: out of bounds
                		}
                		byte* targetByte = &data[idx];
                		shift = bit%8;
                		if(val) {
                			bitSet(*targetByte, shift);
                		} else {
                			bitClear(*targetByte, shift);
                		}
                	}
                ```
                
                - dataì˜ target ìœ„ì¹˜ì— bitì¶”ê°€/ì‚­ì œ
                
            - _writeBytesToRegister
                
                ```cpp
                void _writeBytesToRegister(byte cmd, uint16_t offset, byte data[], uint16_t data_size) {
                			byte header[3];
                			uint8_t headerLen = 1;
                			
                			// TODO proper error handling: address out of bounds
                			// build SPI header
                			if(offset == NO_SUB) {
                				header[0] = WRITE | cmd;
                			} else {
                				header[0] = WRITE_SUB | cmd;
                				if(offset < 128) {
                					header[1] = (byte)offset;
                					headerLen++;
                				} else {
                					header[1] = RW_SUB_EXT | (byte)offset;
                					header[2] = (byte)(offset >> 7);
                					headerLen += 2;
                				}
                			}
                			
                			SPIporting::writeToSPI(_ss, headerLen, header, data_size, data);
                		}
                ```
                

- distance ê´€ë ¨
    
    ```cpp
    DW1000Ng::getReceivedData(data, LEN_DATA);
    
    timeRangeReceived = DW1000Ng::getReceiveTimestamp();
          expectedMsgId = POLL;
          if (!protocolFailed) {
              timePollSent = DW1000NgUtils::bytesAsValue(data + 1, LENGTH_TIMESTAMP);
              timePollAckReceived = DW1000NgUtils::bytesAsValue(data + 6, LENGTH_TIMESTAMP);
              timeRangeSent = DW1000NgUtils::bytesAsValue(data + 11, LENGTH_TIMESTAMP);
              // (re-)compute range as two-way ranging is done
              double distance = DW1000NgRanging::computeRangeAsymmetric(timePollSent,
                                                          timePollReceived, 
                                                          timePollAckSent, 
                                                          timePollAckReceived, 
                                                          timeRangeSent, 
                                                          timeRangeReceived);
              /* Apply simple bias correction */
              distance = DW1000NgRanging::correctRange(distance);
    ```
    
    - getReceivedData
        
        ```cpp
        void getReceivedData(byte data[], uint16_t n) {
        		if(n <= 0) {
        			return;
        		}
        		_readBytesFromRegister(RX_BUFFER, NO_SUB, data, n);
        	}
        ```
        
    
    - _readBytesFromRegister
        
        ```cpp
        void _readBytesFromRegister(byte cmd, uint16_t offset, byte data[], uint16_t data_size) {
        			byte header[3];
        			uint8_t headerLen = 1;
        			
        			// build SPI header
        			if(offset == NO_SUB) {
        				header[0] = READ | cmd;
        			} else {
        				header[0] = READ_SUB | cmd;
        				if(offset < 128) {
        					header[1] = (byte)offset;
        					headerLen++;
        				} else {
        					header[1] = RW_SUB_EXT | (byte)offset;
        					header[2] = (byte)(offset >> 7);
        					headerLen += 2;
        				}
        			}
        
        			SPIporting::readFromSPI(_ss, headerLen, header, data_size, data);
        		}
        ```
        
        - cmd ë ˆì§€ìŠ¤í„°
        - SPIporting::readFromSPI
            
            ```cpp
            void readFromSPI(uint8_t slaveSelectPIN, uint8_t headerLen, byte header[], uint16_t dataLen, byte data[]){
            		_openSPI(slaveSelectPIN);
            		for(auto i = 0; i < headerLen; i++) {
            			_spi->transfer(header[i]); // send header
            		}
            		for(auto i = 0; i < dataLen; i++) {
            			data[i] = _spi->transfer(0x00); // read values
            		}
            		delayMicroseconds(5);
            		_closeSPI(slaveSelectPIN);
            	}
            ```
            
            - 
    
    - getTransmitTimestamp()
        
        ```cpp
        uint64_t getTransmitTimestamp() {
        		byte data[LENGTH_TIMESTAMP];
        		memset(data, 0 , LENGTH_TIMESTAMP);
        		_readBytesFromRegister(TX_TIME, TX_STAMP_SUB, data, LEN_TX_STAMP);
        		return DW1000NgUtils::bytesAsValue(data, LEN_TX_STAMP);
        	}
        ```
        
        ![Untitled](./images/register_map1.png)
        
        - TX_TIME (0x17)ì€ DW1000 ëª¨ë“ˆì˜ ë ˆì§€ìŠ¤í„° ì£¼ì†Œ
    
    - DW1000NgRanging::computeRangeAsymmetric
        
        ```cpp
        double computeRangeAsymmetric(    
                                            uint64_t timePollSent, // 
                                            uint64_t timePollReceived, 
                                            uint64_t timePollAckSent, 
                                            uint64_t timePollAckReceived,
                                            uint64_t timeRangeSent,
                                            uint64_t timeRangeReceived
                                        )
            {
        			  // ì¸ì ë³€ìˆ˜ ì €ì¥
                uint32_t timePollSent_32 = static_cast<uint32_t>(timePollSent);
                uint32_t timePollReceived_32 = static_cast<uint32_t>(timePollReceived);
                uint32_t timePollAckSent_32 = static_cast<uint32_t>(timePollAckSent);
                uint32_t timePollAckReceived_32 = static_cast<uint32_t>(timePollAckReceived);
                uint32_t timeRangeSent_32 = static_cast<uint32_t>(timeRangeSent);
                uint32_t timeRangeReceived_32 = static_cast<uint32_t>(timeRangeReceived);
                
                
                double round1 = static_cast<double>(timePollAckReceived_32 - timePollSent_32);
                double reply1 = static_cast<double>(timePollAckSent_32 - timePollReceived_32);
                double round2 = static_cast<double>(timeRangeReceived_32 - timePollAckSent_32);
                double reply2 = static_cast<double>(timeRangeSent_32 - timePollAckReceived_32);
        
                int64_t tof_uwb = static_cast<int64_t>((round1 * round2 - reply1 * reply2) / (round1 + round2 + reply1 + reply2));
                double distance = tof_uwb * DISTANCE_OF_RADIO;
        
                return distance;
            }
        ```
        

### ì£¼ìš” ë ˆì§€ìŠ¤í„°

---

- SYS_CTRL (0x0D)
    
    ![Untitled](./images/register_map2.png)
    
    - ê° bitì˜ on/off ìƒíƒœì— ë”°ë¼ DW1000ëª¨ë“ˆì˜ ìƒíƒœë¥¼ ì œì–´
    
    ![Untitled](./images/preamble.png)
    

### ê±°ë¦¬ ì¸¡ì •

---

- ê¸°ì¤€ ëª¨ë“ˆ(Anchor)ì—ì„œ ì‹ í˜¸ ì£¼ê¸°ì ìœ¼ë¡œ ì‹ í˜¸ ì „ì†¡
    - Responder íŒŒì¼ì˜ loopë¬¸ì—ì„œ resetInactive ë™ì‘
    - í˜„ì¬ MsgIdë¥¼ POLL ìƒíƒœë¡œ ë³€ê²½í•˜ê³  reciever() ë™ì‘
        - forceTRxOFF : SYS_CTRL ë ˆì§€ìŠ¤í„°ì— TRXOFF (0x06)ë²ˆ ë¹„íŠ¸ trueë¡œ ë³€ê²½ (Transmitì„ ì•ˆí•˜ê² ë‹¤)
        - startReceive
            - SFCST_BIT : FCS (Frame Check Sequence)ì˜ ì¶”ê°€ ì—¬ë¶€ ê²°ì • (on - ì¶”ê°€ x, off - ì¶”ê°€ o)
            - RXDLYS_BIT : Receive ë”œë ˆì´ ì¶”ê°€ (ReceiveMode - Delayedê°€ ì¼œì¡Œì„ ê²½ìš° ì¶”ê°€)
            - RXENAB_BIT : DW1000 ìˆ˜ì‹ ê¸°ë¥¼ ì¼œê³  í”„ë¦¬ì•°ë¸” ì‹œí€€ìŠ¤ ì°¾ê¸° ì‹œì‘ (ëª…ë ¹ í›„ 16us ì§€ì—°ìˆìŒ)
                - í”„ë¦¬ì•°ë¸” - Transmit ë˜ëŠ” ë°ì´í„° í”„ë ˆì„ì˜ ì• ë‹¨ ë¹„íŠ¸